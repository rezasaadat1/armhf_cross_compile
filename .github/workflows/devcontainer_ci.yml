name: Build & Release

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both
  push:
    tags:
      - "v*.*.*"
  pull_request:
    branches: [master, main]

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/armhf_cross_compile/devcontainer

jobs:
  build:
    name: Build ${{ matrix.platform }} (${{ matrix.build_type }})
    strategy:
      fail-fast: false
      matrix:
        platform:
          - arm64
          - armhf
          - armel
          - riscv64
          - amd64
          - i386
        build_type:
          - debug
          - release
        include:
          - platform: arm64
            compiler: aarch64-linux-gnu
          - platform: armhf
            compiler: arm-linux-gnueabihf
          - platform: armel
            compiler: arm-linux-gnueabi
          - platform: riscv64
            compiler: riscv64-linux-gnu
          - platform: amd64
            compiler: x86_64-linux-gnu
          - platform: i386
            compiler: i686-linux-gnu

    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build in Dev Container
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          cacheFrom: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          push: always
          runCmd: |
            export CROSS_ARCH=${{ matrix.platform }}
            export CPP=${{ matrix.compiler }}-g++
            export CC=${{ matrix.compiler }}-gcc

            echo "ðŸ”¨ Building ${{ matrix.platform }} (${{ matrix.build_type }})..."
            echo "   Compiler: $CPP"

            make cross-${{ matrix.build_type }}

            # Rename with build type
            mv firmware_${{ matrix.platform }}.bin firmware_${{ matrix.platform }}_${{ matrix.build_type }}.bin

            # Show binary info
            echo "ðŸ“¦ Binary info:"
            ls -lh firmware_${{ matrix.platform }}_${{ matrix.build_type }}.bin
            file firmware_${{ matrix.platform }}_${{ matrix.build_type }}.bin

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.platform }}-${{ matrix.build_type }}
          path: firmware_${{ matrix.platform }}_${{ matrix.build_type }}.bin
          retention-days: 7

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: firmware_${{ matrix.platform }}_${{ matrix.build_type }}.bin
          asset_name: firmware_${{ matrix.platform }}_${{ matrix.build_type }}_${{ github.ref_name }}.bin
          prerelease: false

  # Summary job that runs after all builds complete
  summary:
    name: Build Summary
    needs: build
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Debug | Release |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| arm64    | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "| armhf    | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "| armel    | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "| riscv64  | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "| amd64    | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "| i386     | âœ…    | âœ…      |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… All builds completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some builds failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          prerelease: true